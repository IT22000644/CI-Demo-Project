name: Auto Create QA/Release Version Branches

on:
  push:
    branches:
      - qa
      - release

jobs:
  create-version-branches:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest commit message
        id: context
        run: |
          echo "branch=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          MSG=$(git log -1 --pretty=%B)
          echo "msg=$MSG" >> $GITHUB_OUTPUT
          echo "🔍 Commit message: $MSG"

      - name: Determine next version branch
        id: version
        run: |
          BRANCH="${{ steps.context.outputs.branch }}"
          MSG="${{ steps.context.outputs.msg }}"
          SRC=""
          DEST=""
          VERSION=""

          echo "Analyzing branch: $BRANCH"
          echo "Message: $MSG"

          # Case 1: dev -> qa => create qa-vX.Y
          if [ "$BRANCH" = "qa" ]; then
            SRC=$(echo "$MSG" | grep -oE "dev[-/]v[0-9]+\.[0-9]+" || true)
            if [ -n "$SRC" ]; then
              VERSION=$(echo "$SRC" | grep -oE "v[0-9]+\.[0-9]+")
              DEST="qa-$VERSION"
            fi
          fi

          # Case 2: qa -> release => create release-vX.Y
          if [ "$BRANCH" = "release" ]; then
            SRC=$(echo "$MSG" | grep -oE "qa[-/]v[0-9]+\.[0-9]+" || true)
            if [ -n "$SRC" ]; then
              VERSION=$(echo "$SRC" | grep -oE "v[0-9]+\.[0-9]+")
              DEST="release-$VERSION"
            fi
          fi

          echo "SRC: $SRC"
          echo "VERSION: $VERSION"
          echo "DEST: $DEST"

          echo "src=$SRC" >> $GITHUB_OUTPUT
          echo "dest=$DEST" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Stop if no matching merge detected
        if: ${{ steps.version.outputs.dest == '' }}
        run: echo "No valid merge pattern detected. Skipping branch creation."

      - name: Create new version branch
        if: ${{ steps.version.outputs.dest != '' }}
        run: |
          git fetch origin
          git checkout ${{ steps.context.outputs.branch }}
          git pull
          git checkout -b ${{ steps.version.outputs.dest }}
          git push origin ${{ steps.version.outputs.dest }}
          echo "Created branch: ${{ steps.version.outputs.dest }}"
